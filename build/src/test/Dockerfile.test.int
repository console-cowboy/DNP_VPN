FROM alpine:3.9 as build

WORKDIR /usr/src/app

RUN apk add --update --no-cache \
    build-base python libpcap-dev linux-headers bash nodejs yarn npm \
    openvpn easy-rsa openssl

# Install all deps (+dev)
COPY build/src/package.json ./
COPY build/src/yarn.lock ./
RUN yarn install
# Copy OpenVPN binaries
COPY build/bin /usr/local/bin
# Copy tests (and src)
COPY build/src .

# ENVs used in other ENV statements
ENV OPENVPN=/etc/openvpn \
    DEFAULT_ADMIN_USER=dappnode_admin

# OpenVPN parameters
ENV EASYRSA=/usr/share/easy-rsa \
    EASYRSA_PKI=$OPENVPN/pki \
    EASYRSA_VARS_FILE=$OPENVPN/vars \
    EASYRSA_CRL_DAYS=3650 \
    EASYRSA_BATCH=yes \
    EASYRSA_ALGO=ec \
    EASYRSA_CURVE=prime256v1 \
    # VPN management parameters - OpenVPN params
    DEFAULT_ADMIN_USER=dappnode_admin \
    OPENVPN_CONF=$OPENVPN/openvpn.conf \
    OPENVPN_ADMIN_PROFILE=$OPENVPN/pki/issued/$DEFAULT_ADMIN_USER.crt \
    OPENVPN_CRED_DIR=/usr/www/openvpn/cred \
    OPENVPN_CCD_DIR=$OPENVPN/ccd \
    ON_CLIENT_CONNECT_PATH=/usr/local/bin/ovpn_client_connect

CMD ["yarn", "run", "test:int"]
